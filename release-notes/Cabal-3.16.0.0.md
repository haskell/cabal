Cabal and Cabal-syntax 3.16.0.0 changelog and release notes
---

### Significant changes

- Make `Flag a` a type synonym for `Last (Maybe a)` [#10948](https://github.com/haskell/cabal/pull/10948)

    Refer to the [Migration guide](#migration-guide) for an upgrade path.

- Add support for Windows AArch64 [#10705](https://github.com/haskell/cabal/pull/10705)

  Adds to preprocessor branches the option to support the `aarch64_HOST_ARCH` platform on the Windows AArch64 target.
  The `ccall` convention is used on AArch64, as with `x86_64_HOST_ARCH`. Introduce `zIsAArch64` to make paths generation support the Windows AArch64 target.

### Other changes

- Add `--with-repl` flag to specify alternative REPL program [#9115](https://github.com/haskell/cabal/issues/9115) [#10996](https://github.com/haskell/cabal/pull/10996)

  Added a new `--with-repl` command-line option that allows specifying an alternative
  program to use when starting a REPL session, instead of the default GHC.

  This is particularly useful for tools like `doctest` and `hie-bios` that need to
  intercept the REPL session to perform their own operations. Previously, these tools
  had to use `--with-ghc` which required them to proxy all GHC invocations, including
  dependency compilation, making the implementation more complex.

  The `--with-repl` option only affects the final REPL invocation, simplifying the
  implementation of such wrapper tools.

  Example usage:
  ```bash
  cabal repl --with-repl=doctest
  cabal repl --with-repl=/path/to/custom/ghc
  ```

  This change also removes the special handling for response files with `--interactive`
  mode, as tools are now expected to handle response files appropriately.

- In the warning about Haddock docs not being  installed, don't imply that the docs exist [#9694](https://github.com/haskell/cabal/issues/9694) [#9695](https://github.com/haskell/cabal/pull/9695)

- Show why `cabal act-as-setup configure` failed [#10273](https://github.com/haskell/cabal/pull/10273)

  When configuring fails, we print a list of "missing or private dependencies".

  Now, it will show you if each failing dependency is missing, private, or an
  incompatible version:

  ```
  Error: [Cabal-8010]
  Encountered missing or private dependencies:
      Lib:{bar-internal,foo-internal} (missing :bar-internal),
      base <=1.0 (installed: 4.18.2.1),
      package-that-does-not-exist (missing)
  ```

- Avoid partial `Data.List.last` in autogenerated `Paths_<pkg>.hs` [#10432](https://github.com/haskell/cabal/pull/10432)

  - Autogenerated `Paths_<pkg>.hs` now avoids use of the partial function `Data.List.last`.

- Fix Haddock CSS handling in multi-package projects [#10636](https://github.com/haskell/cabal/issues/10636) [#10637](https://github.com/haskell/cabal/pull/10637)

  When the `--css=<css-file>` flag is provided to `cabal haddock-project`:

  - the Haddock index is now properly styled by the provided CSS file
  - each package in the project now has its docs properly styled by the provided CSS file

- Add checks for Windows reserved filenames in module paths [#10295](https://github.com/haskell/cabal/issues/10295) [#10816](https://github.com/haskell/cabal/pull/10816)

  On Windows, certain filenames are reserved by the operating system such as
  "aux", "con", "prn", "nul", etc. When these names appear in module paths they
  can cause build failures on Windows systems.

  `cabal check` now properly warns about module paths that contain Windows reserved
  filenames, not just filepaths which contain these reserved tokens. These warnings
  are controlled by the existing `invalid-win-path` category.

  For example, module paths like:
  - `Exe.Aux.Test`
  - `Test.Aux.Module`
  - `Bench.Aux.Helpers`

  will now trigger appropriate warnings during `cabal check`.

- Isolate Cabal from the GHC_ENVIRONMENT variable [#10759](https://github.com/haskell/cabal/issues/10759) [#10828](https://github.com/haskell/cabal/pull/10828) [#10990](https://github.com/haskell/cabal/pull/10990)

  For GHC 8.4.4 and later, Cabal now passes the `-package-env=-` flag to GHC.
  This prevents the `GHC_ENVIRONMENT` variable or any package environment files
  from affecting Cabal builds.

  This change eliminates unexpected build behavior that could occur when users
  had GHC environment files configured in their system that Cabal wasn't aware
  of.

- Set `<pkgname>_datadir` to an absolute path when running tests [#10717](https://github.com/haskell/cabal/issues/10717) [#10830](https://github.com/haskell/cabal/pull/10830)

  Fix a regression where `<pkgname>_datadir` was set to a relative path. This
  caused issues when running testsuites which changed the working directory and
  accessed datafiles.

- Pass `CXX` and `CXXFLAGS` to `./configure` scripts run by Configure build-type [#10797](https://github.com/haskell/cabal/issues/10797) [#10844](https://github.com/haskell/cabal/pull/10844)

  `./configure` scripts run by `build-type: Configure` will now be passed the `CXX` and
  `CXXFLAGS` variables. These reflect the path and flags for the C++ compiler respectively.

  If the compiler is not available, then the flags are not passed. For GHC versions `>= 9.4.*`,
  the `CXX` variable will always be set and available to be used.

  This can be useful for implementing something like `system-cxx-std-lib` in user-land.

- Remove dead build-tool greencard [#10908](https://github.com/haskell/cabal/pull/10908)

  Remove knowledge of the build-tool `greencard` (non-existing since GHC 7.10)
  and the connect of the `.gc` extension to this build-tool.

- Remove knowledge about hmake and haskell-suite [#10912](https://github.com/haskell/cabal/pull/10912)

  The `hmake` tool has long been abandoned, and the `haskell-suite` compiler did not emerge.
  Knowledge about these tools has been removed from `Cabal`.

- Haddock documentation added to Paths_pkgname and PackageInfo_pkgname modules [#10941](https://github.com/haskell/cabal/pull/10941)

  The automatically-generated modules `Paths_pkgname` and `PackageInfo_pkgname`
  now include Haddock documentation.

- `ghc-options` take effect for components built out of js-, cmm- and asm-sources [#10949](https://github.com/haskell/cabal/pull/10949)

  Now we have the ability to pass `ghc-options` flags to all component.

  ```
    js-sources: jsbits/lib.js
    ghc-options: -optJSP-your_flag
  ```

- Adding JavaScript Preprocessor Support [#10967](https://github.com/haskell/cabal/pull/10967)

  Adding new syntax `jspp-options` that would support the `-optJSP` preprocessor flag for js sources.

  ```
    js-sources: jsbits/lib.js
    jspp-options: -DYOUR_FLAG
  ```

- Fix parsing the AbiTag with development versions of GHC [#10170](https://github.com/haskell/cabal/issues/10170) [#10979](https://github.com/haskell/cabal/pull/10979)

- Take `--working-dir` into account in `runPreProcessorWithHsBootHack` [#11000](https://github.com/haskell/cabal/issues/11000) [#10991](https://github.com/haskell/cabal/pull/10991)

  The preprocessor hs-boot hack handles the situation in which a file to be
  preprocessed is supplied alongside an hs-boot file, e.g. Foo.x and Foo.hs-boot
  are given together.
  
  This code now respects the `--working-dir` Cabal global argument. This fixes
  build failures of the form:
  
    ``attempting to use module `Foo' (Foo.hs-boot) which is not loaded``

- Haddock: don't try to copy build dir if it doesn't exist [#11001](https://github.com/haskell/cabal/issues/11001) [#10992](https://github.com/haskell/cabal/pull/10992)

  This small patch fixes a little oversight in 'reusingGHCCompilationArtifacts',
  which would unconditionally attempt to copy over the GHC build artifacts to be
  re-used by Haddock, even when those artifacts did not exist (which caused
  an error).

- add SPDX license data version 3.26 [#11014](https://github.com/haskell/cabal/pull/11014)

  - Update SPDX license list to version 3.26.0 2024-12-30

- Use response files when calling `ghc` [#9367](https://github.com/haskell/cabal/pull/9367)

  Cabal now passes GHC arguments through a response file. This prevents an error
  where very large packages would fail to build due to the module names exceeding
  the `ARG_MAX` command-line length limit:

  ```
  ghc: createProcess: posix_spawnp: resource exhausted (Argument list too long)
  ```

  Notes:
  - RTS options (like `+RTS -H32m -S -RTS`) will not be included in response
    files.
  - For reproducing commands after Cabal exits, `--keep-temp-files` can be used
    to prevent the response files from being deleted.

- New licence constructors for SPDX licences starting with a digit [#10356](https://github.com/haskell/cabal/pull/10356)

  - LicenseId constructor `NullBSD` is now `N_0BSD`.
  - LicenseId constructor `DS389_exception` is now and `N_389_exception`.
  - LicenseId constructor `X3D_Slicer_1_0` is now and `N_3D_Slicer_1_0`.

### Migration guide

- `data Flag a = Flag a | NoFlag` has been replaced with `type Flag = Data.Monoid.Last`,
  while `pattern Flag a = Last (Just a)` and `pattern NoFlag = Last Nothing` are provided
  for backward compatibility.
  Imports of form `import Distribution.Simple.Flag (Flag (..))` should be replaced
  with `import Distribution.Simple.Flag (Flag, pattern Flag, pattern NoFlag)`
  (the latter form is backwards compatible with older versions of Cabal).
  Enable `{-# LANGUAGE PatternSynonyms #-}` if required. In the unlikely case
  of defining instances for `Flag`, `{-# LANGUAGE TypeSynonymInstances #-}`
  is needed.
