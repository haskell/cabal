{-# LANGUAGE DeriveGeneric     #-}
{-# LANGUAGE OverloadedStrings #-}
module Distribution.Simple.Build.Macros.Z (render, Z(..), ZPackage (..), ZTool (..)) where
import Data.ByteString.Builder (Builder)
import qualified Data.ByteString.Builder as BSB
import Distribution.ZinzaPrelude
data Z
    = Z {zPackages :: ([ZPackage]),
         zTools :: ([ZTool]),
         zPackageKey :: String,
         zComponentId :: String,
         zPackageVersion :: Version,
         zNotNull :: (String -> Bool),
         zManglePkgName :: (PackageName -> Builder),
         zMangleStr :: (String -> Builder),
         zMkBuilder :: (String -> Builder)}
    deriving Generic
data ZPackage
    = ZPackage {zpkgName :: PackageName,
                zpkgVersion :: Version,
                zpkgX :: !Int,
                zpkgY :: !Int,
                zpkgZ :: !Int}
    deriving Generic
data ZTool
    = ZTool {ztoolName :: String,
             ztoolVersion :: Version,
             ztoolX :: !Int,
             ztoolY :: !Int,
             ztoolZ :: !Int}
    deriving Generic
render :: Z -> BSB.Builder
render z_root = execWriter $ do
  tell "/* DO NOT EDIT: This file is automatically generated by Cabal */\n"
  tell "\n"
  forM_ (zPackages z_root) $ \z_var0_pkg -> do
    tell "/* package "
    tell (prettyShowBuilder (zpkgName z_var0_pkg))
    tell "-"
    tell (prettyShowBuilder (zpkgVersion z_var0_pkg))
    tell " */\n"
    tell "#ifndef VERSION_"
    tell (id (zManglePkgName z_root (zpkgName z_var0_pkg)))
    tell "\n"
    tell "#define VERSION_"
    tell (id (zManglePkgName z_root (zpkgName z_var0_pkg)))
    tell " \""
    tell (prettyShowBuilder (zpkgVersion z_var0_pkg))
    tell "\"\n"
    tell "#endif /* VERSION_"
    tell (id (zManglePkgName z_root (zpkgName z_var0_pkg)))
    tell " */\n"
    tell "#ifndef MIN_VERSION_"
    tell (id (zManglePkgName z_root (zpkgName z_var0_pkg)))
    tell "\n"
    tell "#define MIN_VERSION_"
    tell (id (zManglePkgName z_root (zpkgName z_var0_pkg)))
    tell "(major1,major2,minor) (\\\n"
    tell "  (major1) <  "
    tell (BSB.intDec (zpkgX z_var0_pkg))
    tell " || \\\n"
    tell "  (major1) == "
    tell (BSB.intDec (zpkgX z_var0_pkg))
    tell " && (major2) <  "
    tell (BSB.intDec (zpkgY z_var0_pkg))
    tell " || \\\n"
    tell "  (major1) == "
    tell (BSB.intDec (zpkgX z_var0_pkg))
    tell " && (major2) == "
    tell (BSB.intDec (zpkgY z_var0_pkg))
    tell " && (minor) <= "
    tell (BSB.intDec (zpkgZ z_var0_pkg))
    tell ")\n"
    tell "#endif /* MIN_VERSION_"
    tell (id (zManglePkgName z_root (zpkgName z_var0_pkg)))
    tell " */\n"
  tell "\n"
  forM_ (zTools z_root) $ \z_var1_tool -> do
    tell "/* tool "
    tell (id (zMkBuilder z_root (ztoolName z_var1_tool)))
    tell "-"
    tell (prettyShowBuilder (ztoolVersion z_var1_tool))
    tell " */\n"
    tell "#ifndef TOOL_VERSION_"
    tell (id (zMangleStr z_root (ztoolName z_var1_tool)))
    tell "\n"
    tell "#define TOOL_VERSION_"
    tell (id (zMangleStr z_root (ztoolName z_var1_tool)))
    tell " \""
    tell (prettyShowBuilder (ztoolVersion z_var1_tool))
    tell "\"\n"
    tell "#endif /* TOOL_VERSION_"
    tell (id (zMangleStr z_root (ztoolName z_var1_tool)))
    tell " */\n"
    tell "#ifndef MIN_TOOL_VERSION_"
    tell (id (zMangleStr z_root (ztoolName z_var1_tool)))
    tell "\n"
    tell "#define MIN_TOOL_VERSION_"
    tell (id (zMangleStr z_root (ztoolName z_var1_tool)))
    tell "(major1,major2,minor) (\\\n"
    tell "  (major1) <  "
    tell (BSB.intDec (ztoolX z_var1_tool))
    tell " || \\\n"
    tell "  (major1) == "
    tell (BSB.intDec (ztoolX z_var1_tool))
    tell " && (major2) <  "
    tell (BSB.intDec (ztoolY z_var1_tool))
    tell " || \\\n"
    tell "  (major1) == "
    tell (BSB.intDec (ztoolX z_var1_tool))
    tell " && (major2) == "
    tell (BSB.intDec (ztoolY z_var1_tool))
    tell " && (minor) <= "
    tell (BSB.intDec (ztoolZ z_var1_tool))
    tell ")\n"
    tell "#endif /* MIN_TOOL_VERSION_"
    tell (id (zMangleStr z_root (ztoolName z_var1_tool)))
    tell " */\n"
  tell "\n"
  if (zNotNull z_root (zPackageKey z_root))
  then do
    tell "#ifndef CURRENT_PACKAGE_KEY\n"
    tell "#define CURRENT_PACKAGE_KEY \""
    tell (id (zMkBuilder z_root (zPackageKey z_root)))
    tell "\"\n"
    tell "#endif /* CURRENT_packageKey */\n"
    return ()
  else do
    return ()
  if (zNotNull z_root (zComponentId z_root))
  then do
    tell "#ifndef CURRENT_COMPONENT_ID\n"
    tell "#define CURRENT_COMPONENT_ID \""
    tell (id (zMkBuilder z_root (zComponentId z_root)))
    tell "\"\n"
    tell "#endif /* CURRENT_COMPONENT_ID */\n"
    return ()
  else do
    return ()
  tell "#ifndef CURRENT_PACKAGE_VERSION\n"
  tell "#define CURRENT_PACKAGE_VERSION \""
  tell (prettyShowBuilder (zPackageVersion z_root))
  tell "\"\n"
  tell "#endif /* CURRENT_PACKAGE_VERSION */\n"
