name: Quick jobs

# See: https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions#concurrency.
concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

on:
  push:
    branches:
      - master
  pull_request:
  release:
    types:
      - created

jobs:
  meta:
    name: Meta checks
    runs-on: ubuntu-latest
    # This job is not run in a container, any recent GHC should be fine
    steps:
      - uses: actions/cache@v4
        with:
          path: ~/.local/state/cabal
          key: linux-store-meta
      # See https://github.com/haskell/cabal/pull/8739
      - name: Sudo chmod to permit ghcup to update its cache
        if: runner.os == 'Linux'
        run: |
            sudo ls -lah /usr/local/.ghcup/cache
            sudo mkdir -p /usr/local/.ghcup/cache
            sudo ls -lah /usr/local/.ghcup/cache
            sudo chown -R "${USER}" /usr/local/.ghcup
            sudo chmod -R 777 /usr/local/.ghcup
      - name: ghcup
        run: |
          ghcup --version
          ghcup config set cache true
          ghcup install ghc recommended
          ghcup set ghc recommended
      - name: Update Hackage index
        run: cabal v2-update
      - name: Install alex
        run: cabal v2-install alex --constraint='alex >=3.2.7.3'
      - run: alex --version
      - uses: actions/checkout@v4
      - name: Regenerate files
        run: |
          make -B lexer
          make -B spdx
          make -B templates
      - name: Check that diff is clean
        run: |
          git status > /dev/null
          git diff-files -p --exit-code
  doctest:
    name: Doctest Cabal
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v4
        with:
          path: ~/.local/state/cabal
          key: linux-store-doctest
      # See https://github.com/haskell/cabal/pull/8739
      - name: Sudo chmod to permit ghcup to update its cache
        if: runner.os == 'Linux'
        run: |
            sudo ls -lah /usr/local/.ghcup/cache
            sudo mkdir -p /usr/local/.ghcup/cache
            sudo ls -lah /usr/local/.ghcup/cache
            sudo chown -R "${USER}" /usr/local/.ghcup
            sudo chmod -R 777 /usr/local/.ghcup
      - name: ghcup
        run: |
          ghcup --version
          ghcup config set cache true
          ghcup install ghc --set recommended
          ghcup install cabal --set latest
      - name: Update Hackage index
        run: cabal v2-update
      - uses: actions/checkout@v4
      - name: Install doctest
        run: make doctest-install
      - name: Doctest
        run: make doctest
  buildinfo:
    name: Check Field Syntax Reference
    runs-on: ubuntu-latest
    steps:
      - uses: actions/cache@v4
        with:
          path: ~/.local/state/cabal
          key: linux-store-buildinfo-doc-diff
      # See https://github.com/haskell/cabal/pull/8739
      - name: Sudo chmod to permit ghcup to update its cache
        if: runner.os == 'Linux'
        run: |
            sudo ls -lah /usr/local/.ghcup/cache
            sudo mkdir -p /usr/local/.ghcup/cache
            sudo ls -lah /usr/local/.ghcup/cache
            sudo chown -R "${USER}" /usr/local/.ghcup
            sudo chmod -R 777 /usr/local/.ghcup
      - name: ghcup
        run: |
          ghcup --version
          ghcup config set cache true
          ghcup install ghc --set recommended
          ghcup install cabal --set latest
      - name: Update Hackage index
        run: cabal v2-update
      - uses: actions/checkout@v4
      - name: Are buildinfo docs up to date?
        run: make doc/buildinfo-fields-reference.rst
  release-project:
    name: Check Release Project
    runs-on: ubuntu-latest
    steps:
      - name: ghcup
        run: |
          ghcup --version
          ghcup config set cache true
          ghcup install ghc --set recommended
          ghcup install cabal --set latest
      - name: Update Hackage Index
        run: cabal v2-update
      - uses: actions/checkout@v4
      - name: Check Release with Pinned Hackage
        run: cabal build all --dry-run --project-file=cabal.project.release
      - name: Check Release with Latest Hackage
        run: cabal build all --dry-run --project-file=cabal.project.release --index-state="hackage.haskell.org HEAD"
